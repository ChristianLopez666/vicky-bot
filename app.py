# ===============================================================
# VICKY CAMPA√ëAS EN REDES ‚Äì APP PRINCIPAL
# Integraci√≥n completa con Meta Cloud API (WhatsApp Business)
# Flujo activo: Pr√©stamos IMSS Ley 73
# Autor: Christian L√≥pez | GPT-5
# ===============================================================

import os
import json
import logging
import requests
import re
import openai
from flask import Flask, request, jsonify
from dotenv import load_dotenv
from datetime import datetime

# ---------------------------------------------------------------
# Cargar variables de entorno
# ---------------------------------------------------------------
load_dotenv()

META_TOKEN = os.getenv("META_TOKEN")
WABA_PHONE_ID = os.getenv("WABA_PHONE_ID")
VERIFY_TOKEN = os.getenv("VERIFY_TOKEN")
ADVISOR_NUMBER = os.getenv("ADVISOR_NUMBER", "5216682478005")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")

# ---------------------------------------------------------------
# Configuraci√≥n de logging
# ---------------------------------------------------------------
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s [%(levelname)s] %(message)s",
)

# ---------------------------------------------------------------
# Inicializaci√≥n de Flask
# ---------------------------------------------------------------
app = Flask(__name__)

# Diccionarios temporales para gestionar el estado de cada usuario
user_state = {}
user_data = {}

# ---------------------------------------------------------------
# CONFIGURACI√ìN GPT MEJORADA
# ---------------------------------------------------------------
openai.api_key = OPENAI_API_KEY

def consultar_gpt(mensaje, contexto=""):
    """Consulta a GPT para interpretaci√≥n de intenciones mejorada"""
    try:
        if not OPENAI_API_KEY:
            return interpret_response_tradicional(mensaje)
            
        prompt = f"""
        Eres un asistente especializado en pr√©stamos IMSS. 
        Contexto: {contexto}
        
        Mensaje del usuario: "{mensaje}"
        
        Responde √öNICAMENTE con:
        - "positive" si la intenci√≥n es AFIRMATIVA (s√≠, acepto, quiero, me interesa)
        - "negative" si la intenci√≥n es NEGATIVA (no, rechazo, no quiero)
        - "neutral" si no es claro
        
        Ejemplos:
        "s√≠" ‚Üí "positive"
        "claro que s√≠" ‚Üí "positive" 
        "no" ‚Üí "negative"
        "para nada" ‚Üí "negative"
        "quiz√°s" ‚Üí "neutral"
        "hola" ‚Üí "neutral"
        """
        
        response = openai.ChatCompletion.create(
            model="gpt-3.5-turbo",
            messages=[
                {"role": "system", "content": "Eres un clasificador de intenciones para pr√©stamos IMSS."},
                {"role": "user", "content": prompt}
            ],
            max_tokens=10,
            temperature=0.1
        )
        
        resultado = response.choices[0].message['content'].strip().lower()
        return resultado if resultado in ['positive', 'negative', 'neutral'] else 'neutral'
        
    except Exception as e:
        logging.error(f"‚ùå Error GPT: {e}")
        return interpret_response_tradicional(mensaje)

def interpret_response_tradicional(text):
    """L√≥gica tradicional de interpretaci√≥n como respaldo"""
    text_lower = (text or '').lower()
    positive_keywords = ['s√≠', 'si', 'sip', 'claro', 'por supuesto', 'ok', 'vale', 'afirmativo', 'acepto', 'yes', 'correcto', 'por su puesto']
    negative_keywords = ['no', 'nop', 'negativo', 'para nada', 'no acepto', 'not', 'nel', 'negativo']
    
    if any(k in text_lower for k in positive_keywords):
        return 'positive'
    if any(k in text_lower for k in negative_keywords):
        return 'negative'
    return 'neutral'

def interpret_response(text, contexto=""):
    """Interpreta respuestas afirmativas/negativas con GPT como respaldo."""
    intent_tradicional = interpret_response_tradicional(text)
    
    if intent_tradicional != 'neutral':
        return intent_tradicional
    
    return consultar_gpt(text, contexto)

# ---------------------------------------------------------------
# Funci√≥n: enviar mensaje por WhatsApp (Meta Cloud API)
# ---------------------------------------------------------------
def send_message(to, text):
    """Env√≠a mensajes de texto al usuario v√≠a Meta Cloud API."""
    try:
        url = f"https://graph.facebook.com/v20.0/{WABA_PHONE_ID}/messages"
        headers = {
            "Authorization": f"Bearer {META_TOKEN}",
            "Content-Type": "application/json"
        }
        payload = {
            "messaging_product": "whatsapp",
            "to": str(to),
            "type": "text",
            "text": {"body": text}
        }
        response = requests.post(url, headers=headers, json=payload)
        if response.status_code not in (200, 201):
            logging.warning(f"‚ö†Ô∏è Error al enviar mensaje: {response.text}")
        else:
            logging.info(f"üì© Mensaje enviado correctamente a {to}")
    except Exception as e:
        logging.exception(f"‚ùå Error en send_message: {e}")

def extract_number(text):
    """Extrae el primer n√∫mero encontrado dentro del texto."""
    if not text:
        return None
    clean = text.replace(',', '').replace('$', '')
    match = re.search(r'(\d{1,9})(?:\.\d+)?\b', clean)
    if match:
        try:
            if ':' in text:
                return None
            return float(match.group(1))
        except ValueError:
            return None
    return None

def is_thankyou_message(text):
    """Detecta mensajes de agradecimiento."""
    text_lower = text.lower().strip()
    thankyou_keywords = [
        'gracias', 'grac', 'gracia', 'thank', 'thanks', 'agradecido', 
        'agradecida', 'agradecimiento', 'te lo agradezco', 'mil gracias'
    ]
    return any(keyword in text_lower for keyword in thankyou_keywords)

def is_valid_name(text):
    """Valida que el texto sea un nombre v√°lido."""
    if not text or len(text.strip()) < 2:
        return False
    if re.match(r'^[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë√º√ú\s\.\-]+$', text.strip()):
        return True
    return False

def is_valid_phone(text):
    """Valida que el texto sea un tel√©fono v√°lido."""
    if not text:
        return False
    clean_phone = re.sub(r'[\s\-\(\)\+]', '', text)
    return re.match(r'^\d{10,15}$', clean_phone) is not None

def send_main_menu(phone):
    menu = (
        "üè¶ *INBURSA - SERVICIOS DISPONIBLES*\n\n"
        "1Ô∏è‚É£ Pr√©stamos IMSS Ley 73\n"
        "2Ô∏è‚É£ Seguros de Auto\n"
        "3Ô∏è‚É£ Seguros de Vida y Salud\n"
        "4Ô∏è‚É£ Tarjetas M√©dicas VRIM\n"
        "5Ô∏è‚É£ Financiamiento Empresarial\n\n"
        "Escribe el *n√∫mero* o el *nombre* del servicio que te interesa:"
    )
    send_message(phone, menu)

def handle_menu_command(phone_number):
    """Maneja el comando menu para reiniciar la conversaci√≥n"""
    user_state.pop(phone_number, None)
    user_data.pop(phone_number, None)
    
    menu_text = (
        "üîÑ *Conversaci√≥n reiniciada*\n\n"
        "üè¶ *INBURSA - SERVICIOS DISPONIBLES*\n\n"
        "1Ô∏è‚É£ Pr√©stamos IMSS Ley 73\n"
        "2Ô∏è‚É£ Seguros de Auto\n"
        "3Ô∏è‚É£ Seguros de Vida y Salud\n"
        "4Ô∏è‚É£ Tarjetas M√©dicas VRIM\n"
        "5Ô∏è‚É£ Financiamiento Empresarial\n\n"
        "Escribe el *n√∫mero* o el *nombre* del servicio que te interesa:"
    )
    send_message(phone_number, menu_text)

def handle_imss_flow(phone_number, user_message):
    """Gestiona el flujo completo del pr√©stamo IMSS Ley 73."""
    msg = user_message.lower()

    imss_keywords = ["pr√©stamo", "prestamo", "imss", "pensi√≥n", "pension", "ley 73", "1"]
    
    if any(keyword in msg for keyword in imss_keywords):
        current_state = user_state.get(phone_number)
        if current_state not in ["esperando_respuesta_imss", "esperando_monto_solicitado", "esperando_respuesta_nomina", "esperando_nombre_imss", "esperando_telefono_imss", "esperando_ciudad_imss"]:
            send_message(phone_number,
                "üëã ¬°Hola! Antes de continuar, necesito confirmar algo importante.\n\n"
                "¬øEres pensionado o jubilado del IMSS bajo la Ley 73? (Responde *s√≠* o *no*)"
            )
            user_state[phone_number] = "esperando_respuesta_imss"
        return True

    if user_state.get(phone_number) == "esperando_respuesta_imss":
        intent = interpret_response(msg, "confirmar si es pensionado IMSS")
        if intent == 'negative':
            send_message(phone_number,
                "Entiendo. Para el pr√©stamo IMSS Ley 73 es necesario ser pensionado del IMSS. üòî\n\n"
                "Pero tengo otros servicios que pueden interesarte:"
            )
            send_main_menu(phone_number)
            user_state.pop(phone_number, None)
        elif intent == 'positive':
            send_message(phone_number,
                "Excelente üëè\n\n¬øQu√© monto de pr√©stamo deseas solicitar?"
            )
            user_state[phone_number] = "esperando_monto_solicitado"
        else:
            send_message(phone_number, 
                "Por favor responde *s√≠* o *no* para continuar:\n\n"
                "‚Ä¢ *S√ç* - Si eres pensionado del IMSS\n"
                "‚Ä¢ *NO* - Si no eres pensionado"
            )
        return True

    if user_state.get(phone_number) == "esperando_monto_solicitado":
        if is_thankyou_message(msg):
            send_message(phone_number,
                "¬°Por nada! üòä\n\n"
                "Sigamos con tu solicitud...\n\n"
                "¬øQu√© monto deseas solicitar?"
            )
            return True
            
        monto = extract_number(msg)
        if monto is not None:
            user_data[phone_number] = {"monto_solicitado": monto}
            
            send_message(phone_number,
                "üéâ *¬°FELICIDADES!* Cumples con los requisitos para el pr√©stamo IMSS Ley 73\n\n"
                f"‚úÖ Monto solicitado: ${monto:,.0f}\n\n"
                "üåü *BENEFICIOS DE TU PR√âSTAMO:*\n"
                "‚Ä¢ Monto desde $40,000 hasta $650,000\n"
                "‚Ä¢ Sin aval\n‚Ä¢ Sin revisi√≥n en Bur√≥\n"
                "‚Ä¢ Descuento directo de tu pensi√≥n\n"
                "‚Ä¢ Tasa preferencial"
            )
            
            send_message(phone_number,
                "üí≥ *PARA ACCEDER A BENEFICIOS ADICIONALES EXCLUSIVOS*:\n\n"
                "¬øTienes tu pensi√≥n depositada en Inbursa o estar√≠as dispuesto a cambiarla?\n\n"
                "üåü *BENEFICIOS ADICIONALES CON N√ìMINA INBURSA:*\n"
                "‚Ä¢ Rendimientos del 80% de Cetes\n"
                "‚Ä¢ Devoluci√≥n del 20% de intereses por pago puntual\n"
                "‚Ä¢ Anticipo de n√≥mina hasta el 50%\n"
                "‚Ä¢ Seguro de vida y Medicall Home (telemedicina 24/7)\n"
                "‚Ä¢ Descuentos en Sanborns y 6,000 comercios\n"
                "‚Ä¢ Retiros sin comisi√≥n en +28,000 puntos\n\n"
                "üí° *No necesitas cancelar tu cuenta actual*\n"
                "üëâ ¬øAceptas cambiar tu n√≥mina a Inbursa? (s√≠/no)"
            )
            user_state[phone_number] = "esperando_respuesta_nomina"
        else:
            send_message(phone_number, "Por favor indica el monto deseado, ejemplo: 65000")
        return True

    if user_state.get(phone_number) == "esperando_respuesta_nomina":
        if is_thankyou_message(msg):
            send_message(phone_number,
                "¬°De nada! üòä\n\n"
                "Para continuar, por favor responde *s√≠* o *no*:\n\n"
                "¬øAceptas cambiar tu n√≥mina a Inbursa para acceder a beneficios adicionales?"
            )
            return True
            
        intent = interpret_response(msg, "cambio de n√≥mina a Inbursa")
        
        data = user_data.get(phone_number, {})
        monto_solicitado = data.get('monto_solicitado', 'N/D')
        
        if intent == 'positive' or intent == 'negative':
            if intent == 'positive':
                send_message(phone_number,
                    "‚úÖ *¬°Excelente decisi√≥n!* Al cambiar tu n√≥mina a Inbursa acceder√°s a todos los beneficios adicionales.\n\n"
                    "Ahora necesitamos algunos datos de contacto:\n\n"
                    "üë§ ¬øCu√°l es tu nombre completo?"
                )
            else:
                send_message(phone_number,
                    "‚úÖ *¬°Perfecto!* Entiendo que por el momento prefieres mantener tu n√≥mina actual.\n\n"
                    "Ahora necesitamos algunos datos de contacto:\n\n"
                    "üë§ ¬øCu√°l es tu nombre completo?"
                )
            
            user_data[phone_number]["nomina_inbursa"] = "ACEPTADA" if intent == 'positive' else "NO POR AHORA"
            user_state[phone_number] = "esperando_nombre_imss"
            
        else:
            send_message(phone_number, 
                "Por favor responde *s√≠* o *no*:\n\n"
                "‚Ä¢ *S√ç* - Para acceder a todos los beneficios adicionales con n√≥mina Inbursa\n"
                "‚Ä¢ *NO* - Para continuar con tu pr√©stamo manteniendo tu n√≥mina actual"
            )
        return True

    if user_state.get(phone_number) == "esperando_nombre_imss":
        if is_valid_name(user_message):
            user_data[phone_number]["nombre_contacto"] = user_message.title()
            send_message(phone_number,
                f"‚úÖ Nombre registrado: {user_message.title()}\n\n"
                "üìû ¬øEn qu√© n√∫mero telef√≥nico podemos contactarte?\n\n"
                "üí° Puedes proporcionar el mismo n√∫mero de WhatsApp o uno diferente"
            )
            user_state[phone_number] = "esperando_telefono_imss"
        else:
            send_message(phone_number,
                "Por favor ingresa un nombre v√°lido (solo letras y espacios):\n\n"
                "Ejemplo: Juan P√©rez Garc√≠a"
            )
        return True

    if user_state.get(phone_number) == "esperando_telefono_imss":
        if is_valid_phone(user_message):
            user_data[phone_number]["telefono_contacto"] = user_message
            send_message(phone_number,
                f"‚úÖ Tel√©fono registrado: {user_message}\n\n"
                "üèôÔ∏è ¬øEn qu√© ciudad te encuentras?"
            )
            user_state[phone_number] = "esperando_ciudad_imss"
        else:
            send_message(phone_number,
                "Por favor ingresa un n√∫mero de tel√©fono v√°lido (10 d√≠gitos m√≠nimo):\n\n"
                "Ejemplo: 6681234567 o +526681234567"
            )
        return True

    if user_state.get(phone_number) == "esperando_ciudad_imss":
        user_data[phone_number]["ciudad"] = user_message.title()
        
        data = user_data.get(phone_number, {})
        monto_solicitado = data.get('monto_solicitado', 'N/D')
        nomina_status = data.get('nomina_inbursa', 'N/D')
        nombre_contacto = data.get('nombre_contacto', 'N/D')
        telefono_contacto = data.get('telefono_contacto', 'N/D')
        ciudad = data.get('ciudad', 'N/D')

        send_message(phone_number,
            "üéâ *¬°Excelente!* Hemos registrado tu solicitud de pr√©stamo IMSS Ley 73.\n\n"
            "üìû *Christian te contactar√° en breve* para:\n\n"
            "‚Ä¢ Confirmar los detalles de tu pr√©stamo\n"
            "‚Ä¢ Explicarte el proceso de desembolso\n"
            "‚Ä¢ Agendar el cambio de n√≥mina si as√≠ lo decidiste\n\n"
            "¬°Gracias por confiar en Inbursa! üè¶"
        )

        mensaje_asesor = (
            f"üî• *NUEVO PROSPECTO IMSS LEY 73 - INFORMACI√ìN COMPLETA*\n\n"
            f"üë§ Nombre: {nombre_contacto}\n"
            f"üìû Tel√©fono WhatsApp: {phone_number}\n"
            f"üì± Tel√©fono contacto: {telefono_contacto}\n"
            f"üèôÔ∏è Ciudad: {ciudad}\n"
            f"üíµ Monto solicitado: ${monto_solicitado:,.0f}\n"
            f"üè¶ N√≥mina Inbursa: {nomina_status}\n\n"
            f"üéØ *Cliente listo para contacto inmediato*"
        )
        send_message(ADVISOR_NUMBER, mensaje_asesor)
        
        user_state.pop(phone_number, None)
        user_data.pop(phone_number, None)
        return True

    return False

def handle_business_flow(phone_number, user_message):
    """Gestiona el flujo completo de cr√©dito empresarial."""
    msg = user_message.lower()

    if user_state.get(phone_number) == "inicio_empresarial":
        send_message(phone_number,
            "üè¢ *Financiamiento Empresarial Inbursa*\n\n"
            "Impulsa el crecimiento de tu negocio con:\n\n"
            "‚úÖ Cr√©ditos desde $100,000 hasta $100,000,000\n"
            "‚úÖ Tasas preferenciales\n"
            "‚úÖ Plazos flexibles\n"
            "‚úÖ Asesor√≠a especializada\n\n"
            "Para comenzar, ¬øqu√© tipo de cr√©dito necesitas?\n\n"
            "‚Ä¢ Capital de trabajo\n"
            "‚Ä¢ Maquinaria y equipo\n" 
            "‚Ä¢ Remodelaci√≥n de local\n"
            "‚Ä¢ Expansi√≥n de negocio\n"
            "‚Ä¢ Otro (especifica)"
        )
        user_state[phone_number] = "esperando_tipo_credito"
        return True

    if user_state.get(phone_number) == "esperando_tipo_credito":
        user_data[phone_number] = {"tipo_credito": user_message}
        send_message(phone_number,
            "üìä Perfecto. ¬øA qu√© se dedica tu empresa? (giro o actividad principal)"
        )
        user_state[phone_number] = "esperando_giro_empresa"
        return True

    if user_state.get(phone_number) == "esperando_giro_empresa":
        user_data[phone_number]["giro_empresa"] = user_message
        send_message(phone_number,
            "üíº ¬øQu√© monto de cr√©dito necesitas?\n\n"
            "Monto m√≠nimo: $100,000 MXN\n"
            "Monto m√°ximo: $100,000,000 MXN\n"
            "Ejemplo: 250000"
        )
        user_state[phone_number] = "esperando_monto_empresarial"
        return True

    if user_state.get(phone_number) == "esperando_monto_empresarial":
        monto = extract_number(msg)
        if monto is not None:
            if monto < 100000:
                send_message(phone_number,
                    "El monto m√≠nimo para cr√©dito empresarial es de $100,000 MXN. üí∞\n\n"
                    "Si deseas solicitar un monto mayor, por favor ingr√©salo:"
                )
                return True
            elif monto > 100000000:
                send_message(phone_number,
                    "El monto m√°ximo para cr√©dito empresarial es de $100,000,000 MXN. üí∞\n\n"
                    "Por favor ingresa un monto dentro del rango permitido:"
                )
                return True
            else:
                user_data[phone_number]["monto_solicitado"] = monto
                send_message(phone_number,
                    f"‚úÖ Monto registrado: ${monto:,.0f}\n\n"
                    "üë§ *Datos de contacto*\n\n"
                    "¬øCu√°l es tu nombre completo?"
                )
                user_state[phone_number] = "esperando_nombre_empresarial"
        else:
            send_message(phone_number, "Por favor ingresa un monto v√°lido, ejemplo: 250000")
        return True

    if user_state.get(phone_number) == "esperando_nombre_empresarial":
        if is_valid_name(user_message):
            user_data[phone_number]["nombre_contacto"] = user_message.title()
            send_message(phone_number,
                f"‚úÖ Nombre registrado: {user_message.title()}\n\n"
                "üìû ¬øEn qu√© n√∫mero telef√≥nico podemos contactarte?\n\n"
                "üí° Puedes proporcionar el mismo n√∫mero de WhatsApp o uno diferente"
            )
            user_state[phone_number] = "esperando_telefono_empresarial"
        else:
            send_message(phone_number,
                "Por favor ingresa un nombre v√°lido (solo letras y espacios):\n\n"
                "Ejemplo: Juan P√©rez Garc√≠a"
            )
        return True

    if user_state.get(phone_number) == "esperando_telefono_empresarial":
        if is_valid_phone(user_message):
            user_data[phone_number]["telefono_contacto"] = user_message
            send_message(phone_number,
                f"‚úÖ Tel√©fono registrado: {user_message}\n\n"
                "üèôÔ∏è ¬øEn qu√© ciudad se encuentra tu empresa?"
            )
            user_state[phone_number] = "esperando_ciudad_empresarial"
        else:
            send_message(phone_number,
                "Por favor ingresa un n√∫mero de tel√©fono v√°lido (10 d√≠gitos m√≠nimo):\n\n"
                "Ejemplo: 6681234567 o +526681234567"
            )
        return True

    if user_state.get(phone_number) == "esperando_ciudad_empresarial":
        user_data[phone_number]["ciudad_empresa"] = user_message.title()
        send_message(phone_number,
            f"‚úÖ Ciudad registrada: {user_message.title()}\n\n"
            "üìÖ ¬øQu√© d√≠a y horario prefieres para que te contacte un especialista?\n\n"
            "Ejemplo: Lunes a viernes de 9am a 2pm"
        )
        user_state[phone_number] = "esperando_contacto_empresarial"
        return True

    if user_state.get(phone_number) == "esperando_contacto_empresarial":
        user_data[phone_number]["horario_contacto"] = user_message
        
        data = user_data.get(phone_number, {})
        
        send_message(phone_number,
            "üéâ *¬°Excelente!* Hemos registrado tu solicitud de financiamiento empresarial.\n\n"
            "üìû *Un especialista en negocios te contactar√°* en el horario indicado para:\n\n"
            "‚Ä¢ Analizar tu proyecto a detalle\n"
            "‚Ä¢ Explicarte las mejores opciones de cr√©dito\n"
            "‚Ä¢ Orientarte sobre los requisitos y documentaci√≥n\n\n"
            "¬°Gracias por considerar a Inbursa para impulsar tu empresa! üè¢"
        )

        mensaje_asesor = (
            f"üè¢ *NUEVO PROSPECTO EMPRESARIAL - INFORMACI√ìN COMPLETA*\n\n"
            f"üë§ Nombre: {data.get('nombre_contacto', 'N/D')}\n"
            f"üìû Tel√©fono WhatsApp: {phone_number}\n"
            f"üì± Tel√©fono contacto: {data.get('telefono_contacto', phone_number)}\n"
            f"üèôÔ∏è Ciudad: {data.get('ciudad_empresa', 'N/D')}\n"
            f"üìä Tipo de cr√©dito: {data.get('tipo_credito', 'N/D')}\n"
            f"üè≠ Giro empresa: {data.get('giro_empresa', 'N/D')}\n"
            f"üíµ Monto solicitado: ${data.get('monto_solicitado', 'N/D'):,.0f}\n"
            f"üìÖ Horario contacto: {data.get('horario_contacto', 'N/D')}\n\n"
            f"üéØ *Cliente potencial para cr√©dito empresarial*"
        )
        send_message(ADVISOR_NUMBER, mensaje_asesor)
        
        user_state.pop(phone_number, None)
        user_data.pop(phone_number, None)
        return True

    return False

def handle_menu_options(phone_number, user_message):
    """Maneja las opciones del men√∫ principal."""
    msg = user_message.lower().strip()
    
    menu_options = {
        '1': 'imss',
        'pr√©stamo': 'imss',
        'prestamo': 'imss',
        'imss': 'imss',
        'ley 73': 'imss',
        '2': 'seguro_auto',
        'seguro auto': 'seguro_auto',
        'seguros de auto': 'seguro_auto',
        'auto': 'seguro_auto',
        '3': 'seguro_vida',
        'seguro vida': 'seguro_vida',
        'seguros de vida': 'seguro_vida',
        'seguro salud': 'seguro_vida',
        'vida': 'seguro_vida',
        '4': 'vrim',
        'tarjetas m√©dicas': 'vrim',
        'tarjetas medicas': 'vrim',
        'vrim': 'vrim',
        '5': 'empresarial',
        'financiamiento empresarial': 'empresarial',
        'empresa': 'empresarial',
        'negocio': 'empresarial',
        'pyme': 'empresarial',
        'cr√©dito empresarial': 'empresarial',
        'credito empresarial': 'empresarial'
    }
    
    option = menu_options.get(msg)
    
    if option == 'imss':
        return handle_imss_flow(phone_number, "pr√©stamo")
    elif option == 'seguro_auto':
        send_message(phone_number,
            "üöó *Seguros de Auto Inbursa*\n\n"
            "Protege tu auto con las mejores coberturas:\n\n"
            "‚úÖ Cobertura amplia contra todo riesgo\n"
            "‚úÖ Asistencia vial las 24 horas\n"
            "‚úÖ Responsabilidad civil\n"
            "‚úÖ Robo total y parcial\n\n"
            "üìû Un asesor se comunicar√° contigo para cotizar tu seguro."
        )
        send_message(ADVISOR_NUMBER, f"üöó NUEVO INTERESADO EN SEGURO DE AUTO\nüìû {phone_number}")
        return True
    elif option == 'seguro_vida':
        send_message(phone_number,
            "üè• *Seguros de Vida y Salud Inbursa*\n\n"
            "Protege a tu familia y tu salud:\n\n"
            "‚úÖ Seguro de vida\n"
            "‚úÖ Gastos m√©dicos mayores\n"
            "‚úÖ Hospitalizaci√≥n\n"
            "‚úÖ Atenci√≥n m√©dica las 24 horas\n\n"
            "üìû Un asesor se comunicar√° contigo para explicarte las coberturas."
        )
        send_message(ADVISOR_NUMBER, f"üè• NUEVO INTERESADO EN SEGURO VIDA/SALUD\nüìû {phone_number}")
        return True
    elif option == 'vrim':
        send_message(phone_number,
            "üí≥ *Tarjetas M√©dicas VRIM*\n\n"
            "Accede a la mejor atenci√≥n m√©dica:\n\n"
            "‚úÖ Consultas m√©dicas ilimitadas\n"
            "‚úÖ Especialistas y estudios de laboratorio\n"
            "‚úÖ Medicamentos con descuento\n"
            "‚úÖ Atenci√≥n dental y oftalmol√≥gica\n\n"
            "üìû Un asesor se comunicar√° contigo para explicarte los beneficios."
        )
        send_message(ADVISOR_NUMBER, f"üí≥ NUEVO INTERESADO EN TARJETAS VRIM\nüìû {phone_number}")
        return True
    elif option == 'empresarial':
        user_state[phone_number] = "inicio_empresarial"
        return handle_business_flow(phone_number, "inicio")
    
    return False

@app.route("/webhook", methods=["GET"])
def verify_webhook():
    mode = request.args.get("hub.mode")
    token = request.args.get("hub.verify_token")
    challenge = request.args.get("hub.challenge")
    if mode == "subscribe" and token == VERIFY_TOKEN:
        logging.info("‚úÖ Webhook verificado correctamente.")
        return challenge, 200
    logging.warning("‚ùå Verificaci√≥n de webhook fallida.")
    return "Forbidden", 403

@app.route("/webhook", methods=["POST"])
def receive_message():
    try:
        data = request.get_json()
        logging.info(f"üì© Datos recibidos: {json.dumps(data, ensure_ascii=False)}")

        entry = data.get("entry", [])[0]
        change = entry.get("changes", [])[0]
        value = change.get("value", {})
        messages = value.get("messages", [])

        if not messages:
            return jsonify({"status": "ignored"}), 200

        message = messages[0]
        phone_number = message.get("from")
        message_type = message.get("type")

        if message_type == "text":
            user_message = message["text"]["body"].strip()
            
            logging.info(f"üì± Mensaje de {phone_number}: '{user_message}'")

            if user_message.lower() in ["menu", "men√∫", "men", "opciones", "servicios"]:
                handle_menu_command(phone_number)
                return jsonify({"status": "ok"}), 200

            if is_thankyou_message(user_message):
                send_message(phone_number,
                    "¬°De nada! üòä\n\n"
                    "Quedo a tus √≥rdenes para cualquier otra cosa.\n\n"
                    "¬øHay algo m√°s en lo que pueda ayudarte?"
                )
                return jsonify({"status": "ok"}), 200

            if user_state.get(phone_number) in ["esperando_respuesta_imss", "esperando_monto_solicitado", "esperando_respuesta_nomina", "esperando_nombre_imss", "esperando_telefono_imss", "esperando_ciudad_imss"]:
                if handle_imss_flow(phone_number, user_message):
                    return jsonify({"status": "ok"}), 200

            if user_state.get(phone_number) in ["inicio_empresarial", "esperando_tipo_credito", 
                                              "esperando_giro_empresa", "esperando_monto_empresarial",
                                              "esperando_nombre_empresarial", "esperando_telefono_empresarial",
                                              "esperando_ciudad_empresarial", "esperando_contacto_empresarial"]:
                if handle_business_flow(phone_number, user_message):
                    return jsonify({"status": "ok"}), 200

            if handle_menu_options(phone_number, user_message):
                return jsonify({"status": "ok"}), 200

            if user_message.lower() in ["hola", "hi", "hello", "buenas", "buenos d√≠as", "buenas tardes"]:
                send_message(phone_number,
                    "üëã ¬°Hola! Soy *Vicky*, tu asistente virtual de Inbursa.\n\n"
                    "üè¶ *SERVICIOS DISPONIBLES:*\n"
                    "1Ô∏è‚É£ Pr√©stamos IMSS Ley 73\n"
                    "2Ô∏è‚É£ Seguros de Auto\n"
                    "3Ô∏è‚É£ Seguros de Vida y Salud\n"
                    "4Ô∏è‚É£ Tarjetas M√©dicas VRIM\n"
                    "5Ô∏è‚É£ Financiamiento Empresarial\n\n"
                    "Escribe el *n√∫mero* o el *nombre* del servicio que te interesa.\n\n"
                    "Tambi√©n puedes escribir *men√∫* en cualquier momento."
                )
            else:
                send_message(phone_number,
                    "üëã Hola, soy *Vicky*, tu asistente de Inbursa.\n\n"
                    "No entend√≠ tu mensaje. Te puedo ayudar con:\n\n"
                    "üè¶ *SERVICIOS DISPONIBLES:*\n"
                    "‚Ä¢ Pr√©stamos IMSS (escribe '1' o 'pr√©stamo')\n"  
                    "‚Ä¢ Seguros de Auto ('2' o 'seguro auto')\n"
                    "‚Ä¢ Seguros de Vida ('3' o 'seguro vida')\n"
                    "‚Ä¢ Tarjetas M√©dicas VRIM ('4' o 'vrim')\n"
                    "‚Ä¢ Financiamiento Empresarial ('5' o 'empresa')\n\n"
                    "Escribe *men√∫* para ver todas las opciones organizadas."
                )
            return jsonify({"status": "ok"}), 200

        else:
            send_message(phone_number, 
                "Por ahora solo puedo procesar mensajes de texto üì©\n\n"
                "Escribe *men√∫* para ver los servicios disponibles."
            )
            return jsonify({"status": "ok"}), 200

    except Exception as e:
        logging.exception(f"‚ùå Error en receive_message: {e}")
        return jsonify({"error": str(e)}), 500

@app.route("/health", methods=["GET"])
def health():
    return jsonify({"status": "ok", "service": "Vicky Bot Inbursa"}), 200

if __name__ == "__main__":
    port = int(os.getenv("PORT", 5000))
    logging.info(f"üöÄ Iniciando Vicky Bot en puerto {port}")
    app.run(host="0.0.0.0", port=port)
